<script type="text/javascript">
  $(document).ready(function(){
    // background
    $('#seated_plan_background').change(function(){
      $('.sf_admin_form_field_show_picture .picture')
        .css('background-color', $(this).val());
    }).change();
    
    // seat plots precondition for a good display
    $('.sf_admin_form_field_show_picture .picture')
      .css('display', 'block')
      .width($(this).find('img').width())
      .height($(this).find('img').height())
      .find('img').css('position', 'absolute');
    
    // seat plots
    $('.sf_admin_form_field_show_picture img').click(function(event){
      ref = $(this).parent();
      position = {
        x: event.pageX-ref.position().left,
        y: event.pageY-ref.position().top
      };
      
      // the seat name
      name = prompt('<?php echo __("Seat's name") ?>');
      // then verify its unicity for this seated plan
      
      // adding the seat / plot
      if ( name )
      $('<div class="seat" title="'+name+'"><span class="txt">'+name+'</span></div>')
        .addClass('seat-'+$('.sf_admin_form_field_show_picture .seat').length)
        .css('width', $('#seated_plan_seat_diameter').val()+'em')
        .css('height', $('#seated_plan_seat_diameter').val()+'em')
        .css('position', 'absolute').each(function(){
          $(this).css('left', (x = position['x'])-$(this).width()/2)
          $(this).css('top',  (y = position['y'])-$(this).width()/2)
        }).prependTo(ref)
        .clone(true).addClass('txt').prependTo(ref)
        .dblclick(function(){
          // DB removal
          // TODO
          
          // graphical removal
          $(this).parent().find('.seat.'+$(this).clone(true).removeClass('seat').removeClass('txt').attr('class')).remove();
        });
      
      // save the plot record
      // x, y, name
      // TODO
      // if failed remove the graphical plot
    })
    
    // removing last plot
    $(document).keypress(function(event){
      if ( event.which == 122 && event.ctrlKey )
        $('.sf_admin_form_field_show_picture .seat.txt:first').dblclick();
    });
    
  });
</script>
