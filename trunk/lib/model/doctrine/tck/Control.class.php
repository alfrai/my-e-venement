<?php

/**
 * Control
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    e-venement
 * @subpackage model
 * @author     Baptiste SIMON <baptiste.simon AT e-glop.net>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $sfConfig::get('app_tickets_id')sfConfig::get('app_tickets_id')
 */
class Control extends PluginControl
{
  public function preSave($event)
  {
    if ( sfConfig::has('app_tickets_id') && sfConfig::get('app_tickets_id') != 'id' )
    {
      $past = sfConfig::get('app_control_past') ? sfConfig::get('app_control_past') : '6 hours';
      $future = sfConfig::get('app_control_future') ? sfConfig::get('app_control_future') : '1 day';

      $field = sfConfig::get('app_tickets_id') == 'barcode' ? 'barcode' : 'othercode';
      $q = Doctrine::getTable('Ticket')->createQuery('t')
        ->leftJoin('t.Manifestation m')
        ->andWhere($field.' = ?',$this->ticket_id)
        ->andWhere('t.manifestation_id IN (SELECT mm.id FROM checkpoint c LEFT JOIN c.Event e LEFT JOIN e.Manifestations mm WHERE c.id = ?)',$this->checkpoint_id)
        ->andWhere('m.happens_at < ?',date('Y-m-d H:i',strtotime('now + '.$future)))
        ->andWhere('m.happens_at >= ?',date('Y-m-d H:i',strtotime('now - '.$past)))
        ->andWhere('t.printed')
        ->orderBy('m.happens_at');
      $tickets = $q->execute();

      $this->ticket_id = $tickets[0]['id'];
    }
    
    return parent::preSave($event);
  }
}
